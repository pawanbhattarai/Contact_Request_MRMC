<?php
/**
 * Plugin Name:       Mahendraratna Scholarship Form
 * Plugin URI:        https://example.com/plugins/the-basics/
 * Description:       Adds a scholarship form via shortcode [mahendraratna_scholarship_form] and manages submissions in the admin panel under "Scholarship".
 * Version:           1.0.1
 * Requires at least: 5.2
 * Requires PHP:      7.2
 * Author:            Your Name
 * Author URI:        https://author.example.com/
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       mr-scholarship
 * Domain Path:       /languages
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly.
}

define('MR_SCHOLARSHIP_VERSION', '1.0.1');
define('MR_SCHOLARSHIP_PLUGIN_PATH', plugin_dir_path(__FILE__));
define('MR_SCHOLARSHIP_PLUGIN_URL', plugin_dir_url(__FILE__));
define('MR_SCHOLARSHIP_INCLUDES_PATH', MR_SCHOLARSHIP_PLUGIN_PATH . 'includes/');
define('MR_SCHOLARSHIP_ASSETS_PATH', MR_SCHOLARSHIP_PLUGIN_PATH . 'assets/'); // Added for CSS path
define('MR_SCHOLARSHIP_ASSETS_URL', MR_SCHOLARSHIP_PLUGIN_URL . 'assets/');

global $wpdb;
define('MR_SCHOLARSHIP_TABLE_NAME', $wpdb->prefix . 'scholarship_submissions');

// --- Activation Hook ---
register_activation_hook(__FILE__, 'mr_scholarship_activate');
function mr_scholarship_activate()
{
    mr_scholarship_create_db_table();
}

// --- Database Table Creation ---
function mr_scholarship_create_db_table()
{
    global $wpdb;
    $charset_collate = $wpdb->get_charset_collate();
    $table_name = MR_SCHOLARSHIP_TABLE_NAME;

    // Check if table exists before creating (best practice, though dbDelta handles it)
    // if ( $wpdb->get_var( "SHOW TABLES LIKE '$table_name'" ) != $table_name ) { // dbDelta checks anyway

    // Using utf8mb4 for better character support
    $sql = "CREATE TABLE $table_name (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        submission_time datetime DEFAULT '0000-00-00 00:00:00' NOT NULL,
        name_nepali tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        name_english tinytext DEFAULT NULL,
        dob_year_bs varchar(4) DEFAULT NULL,
        dob_month_bs varchar(20) DEFAULT NULL,
        dob_day_bs varchar(2) DEFAULT NULL,
        address_district VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        address_municipality VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        address_ward VARCHAR(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        father_name tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        father_occupation tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        grandfather_name tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        grandfather_occupation tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        faculty tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        ac_level tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        ac_year tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL, -- Fixed: Added UTF8 support
        admission_year varchar(4) DEFAULT NULL,
        roll_no varchar(20) DEFAULT NULL,
        phone_no varchar(20) DEFAULT NULL,
        bank_name varchar(50) DEFAULT NULL,
        account_no varchar(50) DEFAULT NULL,
        bank_branch tinytext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_plus2_institution text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_plus2_gpa varchar(10) DEFAULT NULL,
        academic_plus2_remarks text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor1_institution text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor1_gpa varchar(10) DEFAULT NULL,
        academic_bachelor1_remarks text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor2_institution text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor2_gpa varchar(10) DEFAULT NULL,
        academic_bachelor2_remarks text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor3_institution text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        academic_bachelor3_gpa varchar(10) DEFAULT NULL,
        academic_bachelor3_remarks text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
        document_1 text DEFAULT NULL,
        document_2 text DEFAULT NULL,
        document_3 text DEFAULT NULL,
        submit_year_bs varchar(4) DEFAULT NULL,
        submit_month_bs varchar(20) DEFAULT NULL,
        submit_day_bs varchar(2) DEFAULT NULL,
        PRIMARY KEY  (id)
    ) $charset_collate;";
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

// --- Enqueue Frontend Styles ---
add_action('wp_enqueue_scripts', 'mr_scholarship_enqueue_styles');
function mr_scholarship_enqueue_styles()
{
    // Only load the CSS if the shortcode is likely present
    global $post;
    if (is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'mahendraratna_scholarship_form')) {
        wp_enqueue_style('mr-scholarship-style', MR_SCHOLARSHIP_ASSETS_URL . 'css/mr-scholarship-style.css', array(), MR_SCHOLARSHIP_VERSION);
    }
}


// --- Shortcode Registration & Handler ---
add_shortcode('mahendraratna_scholarship_form', 'mr_scholarship_form_shortcode_handler');
function mr_scholarship_form_shortcode_handler()
{
    global $wpdb;
    $table_name = MR_SCHOLARSHIP_TABLE_NAME;
    $feedback_message = '';
    $message_class = '';

    // --- Handle Form Submission ---
    if (isset($_POST['mr_scholarship_submit']) && isset($_POST['mr_scholarship_nonce'])) {
        // Enhanced debugging
        if (WP_DEBUG === true) {
            error_log('Scholarship form submitted');
            error_log('POST data: ' . print_r($_POST, true));

            // Specifically check ac_year field
            error_log('ac_year value: ' . (isset($_POST['ac_year']) ? $_POST['ac_year'] : 'NOT SET'));

            // Check if file uploads are present
            if (!empty($_FILES)) {
                error_log('Files uploaded: ' . print_r($_FILES, true));
            }
        }

        if (!wp_verify_nonce(sanitize_key($_POST['mr_scholarship_nonce']), 'mr_scholarship_form_action')) {
            // Nonce is invalid
            $feedback_message = esc_html__('Security check failed. Please try submitting again.', 'mr-scholarship');
            $message_class = 'error';
        } else {
            // Nonce is valid, process the data
            $data = array();
            $data['submission_time'] = current_time('mysql');

            // Enhanced field sanitization with debugging
            $fields_to_sanitize = [
                'name_nepali',
                'name_english',
                'dob_year_bs',
                'dob_month_bs',
                'dob_day_bs',
                'address_district',
                'address_municipality',
                'address_ward',
                'father_name',
                'father_occupation',
                'grandfather_name',
                'grandfather_occupation',
                'faculty',
                'ac_level',
                'ac_year',  // Make sure this is included
                'admission_year',
                'roll_no',
                'phone_no',
                'account_no',
                'bank_branch',
                'academic_plus2_institution',
                'academic_plus2_gpa',
                'academic_plus2_remarks',
                'academic_bachelor1_institution',
                'academic_bachelor1_gpa',
                'academic_bachelor1_remarks',
                'academic_bachelor2_institution',
                'academic_bachelor2_gpa',
                'academic_bachelor2_remarks',
                'academic_bachelor3_institution',
                'academic_bachelor3_gpa',
                'academic_bachelor3_remarks',
                'submit_year_bs',
                'submit_month_bs',
                'submit_day_bs'
            ];

            foreach ($fields_to_sanitize as $field) {
                if (isset($_POST[$field])) {
                    // Enhanced debugging for ac_year
                    if ($field === 'ac_year' && WP_DEBUG) {
                        error_log("Processing ac_year: Raw value = '" . $_POST[$field] . "'");
                    }

                    // Adjust sanitization based on field type - FIXED ac_year handling
                    if (strpos($field, 'remarks') !== false || strpos($field, 'institution') !== false || strpos($field, 'address_') !== false) {
                        $data[$field] = sanitize_textarea_field($_POST[$field]);
                    } elseif ($field === 'phone_no' || $field === 'roll_no' || $field === 'account_no' || strpos($field, '_gpa') !== false) {
                        $data[$field] = sanitize_text_field(preg_replace('/[^-0-9.%]/', '', $_POST[$field]));
                    } elseif (strpos($field, '_year') !== false && $field !== 'ac_year') { // FIXED: Exclude ac_year from numeric-only processing
                        $data[$field] = sanitize_text_field(preg_replace('/[^0-9]/', '', $_POST[$field]));
                    } elseif ($field === 'address_ward' || strpos($field, '_day') !== false) {
                        $data[$field] = sanitize_text_field(preg_replace('/[^0-9]/', '', $_POST[$field]));
                    } else {
                        // This will handle ac_year as regular text field, preserving all characters including Nepali
                        $data[$field] = sanitize_text_field($_POST[$field]);
                    }

                    // Additional debugging for ac_year
                    if ($field === 'ac_year' && WP_DEBUG) {
                        error_log("Processed ac_year: Sanitized value = '" . $data[$field] . "'");
                    }
                } else {
                    $data[$field] = null;

                    // Log missing fields
                    if (WP_DEBUG) {
                        error_log("Missing field in POST: $field");
                    }
                }
            }

            // Enhanced debugging before database insertion
            if (WP_DEBUG) {
                error_log('Final data array for database insertion:');
                error_log('ac_year final value: ' . ($data['ac_year'] ?? 'NULL'));
                error_log('All data: ' . print_r($data, true));
            }

            // Handle radio button for bank_name specifically
            $data['bank_name'] = isset($_POST['bank_name']) ? sanitize_text_field($_POST['bank_name']) : null;

            // Handle file uploads
            $upload_dir = wp_upload_dir();
            $upload_basedir = $upload_dir['basedir'] . '/mr-scholarship-uploads';

            // Create directory if it doesn't exist
            if (!file_exists($upload_basedir)) {
                wp_mkdir_p($upload_basedir);

                // Create an index.php file to prevent directory listing
                $index_file = fopen($upload_basedir . '/index.php', 'w');
                fwrite($index_file, '<?php // Silence is golden');
                fclose($index_file);

                // Create .htaccess to further secure the directory
                $htaccess_file = fopen($upload_basedir . '/.htaccess', 'w');
                fwrite($htaccess_file, 'Options -Indexes' . PHP_EOL);
                fwrite($htaccess_file, '<FilesMatch ".(php|php5|phtml)$">' . PHP_EOL);
                fwrite($htaccess_file, 'Order Allow,Deny' . PHP_EOL);
                fwrite($htaccess_file, 'Deny from all' . PHP_EOL);
                fwrite($htaccess_file, '</FilesMatch>' . PHP_EOL);
                fclose($htaccess_file);
            }

            // File field names
            $file_fields = ['document_1', 'document_2', 'document_3'];

            // Process each file
            // Enhanced file upload handling in your form submission processing
            foreach ($file_fields as $file_field) {
                if (!empty($_FILES[$file_field]['name'])) {
                    // Setup allowed file types
                    $allowed_file_types = ['pdf', 'jpg', 'jpeg', 'png'];
                    $max_file_size = 2 * 1024 * 1024; // 2MB limit

                    $file_tmp = $_FILES[$file_field]['tmp_name'];
                    $file_name = sanitize_file_name($_FILES[$file_field]['name']);
                    $file_size = $_FILES[$file_field]['size'];
                    $file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $upload_error = $_FILES[$file_field]['error'];

                    // Log upload attempt for debugging
                    if (WP_DEBUG) {
                        error_log("Processing file upload for field: $file_field");
                        error_log("Original filename: $file_name, Size: $file_size bytes, Type: $file_ext");
                    }

                    // Check for PHP upload errors
                    if ($upload_error !== UPLOAD_ERR_OK) {
                        $error_message = mr_scholarship_get_upload_error_message($upload_error);
                        $feedback_message = sprintf(__('Error uploading %s: %s', 'mr-scholarship'), $file_name, $error_message);
                        $message_class = 'error';
                        if (WP_DEBUG) {
                            error_log("Upload error: $error_message");
                        }
                        break;
                    }

                    // Check if file size is valid
                    if ($file_size > $max_file_size) {
                        $feedback_message = sprintf(__('File %s is too large. Maximum allowed size is 2MB.', 'mr-scholarship'), $file_name);
                        $message_class = 'error';
                        if (WP_DEBUG) {
                            error_log("File too large: $file_size bytes");
                        }
                        break;
                    }

                    // Check if file type is allowed
                    if (!in_array($file_ext, $allowed_file_types)) {
                        $feedback_message = sprintf(__('Invalid file type for %s. Please upload only PDF, JPG, or PNG files.', 'mr-scholarship'), $file_name);
                        $message_class = 'error';
                        if (WP_DEBUG) {
                            error_log("Invalid file type: $file_ext");
                        }
                        break;
                    }

                    // Generate unique filename
                    $new_file_name = uniqid() . '_' . $file_name;
                    $upload_path = $upload_basedir . '/' . $new_file_name;
                    $upload_url = $upload_dir['baseurl'] . '/mr-scholarship-uploads/' . $new_file_name;

                    // Move file to upload directory
                    if (move_uploaded_file($file_tmp, $upload_path)) {
                        // Store file path in database - store both URL and file path
                        $data[$file_field] = $upload_url;

                        if (WP_DEBUG) {
                            error_log("File uploaded successfully to: $upload_path");
                            error_log("File URL saved as: $upload_url");
                        }
                    } else {
                        $feedback_message = sprintf(__('Error moving uploaded file %s to destination.', 'mr-scholarship'), $file_name);
                        $message_class = 'error';
                        if (WP_DEBUG) {
                            error_log("Failed to move uploaded file from $file_tmp to $upload_path");
                            error_log("PHP error: " . error_get_last()['message']);
                        }
                        break;
                    }
                }
            }

            // Helper function to get readable upload error messages
            function mr_scholarship_get_upload_error_message($error_code)
            {
                switch ($error_code) {
                    case UPLOAD_ERR_INI_SIZE:
                        return __('The uploaded file exceeds the upload_max_filesize directive in php.ini', 'mr-scholarship');
                    case UPLOAD_ERR_FORM_SIZE:
                        return __('The uploaded file exceeds the MAX_FILE_SIZE directive in the HTML form', 'mr-scholarship');
                    case UPLOAD_ERR_PARTIAL:
                        return __('The uploaded file was only partially uploaded', 'mr-scholarship');
                    case UPLOAD_ERR_NO_FILE:
                        return __('No file was uploaded', 'mr-scholarship');
                    case UPLOAD_ERR_NO_TMP_DIR:
                        return __('Missing a temporary folder', 'mr-scholarship');
                    case UPLOAD_ERR_CANT_WRITE:
                        return __('Failed to write file to disk', 'mr-scholarship');
                    case UPLOAD_ERR_EXTENSION:
                        return __('A PHP extension stopped the file upload', 'mr-scholarship');
                    default:
                        return __('Unknown upload error', 'mr-scholarship');
                }
            }

            // Only proceed with DB insertion if no errors in file uploads
            if (empty($feedback_message)) {
                // Prepare data formats for DB insertion (especially for text fields needing UTF8 support)
                $data_formats = array_fill(0, count($data), '%s'); // Default to string format

                // Insert data into the database
                $result = $wpdb->insert($table_name, $data, $data_formats);

                if ($result) {
                    $feedback_message = esc_html__('Your application has been submitted successfully.', 'mr-scholarship');
                    $message_class = 'success';
                    // Clear POST to prevent resubmission on refresh only on success
                    $_POST = array();
                } else {
                    $feedback_message = esc_html__('There was an error submitting your application. Please try again.', 'mr-scholarship') . ' ' . $wpdb->last_error;
                    $message_class = 'error';
                }
            }
        }
    }

    // --- Display the Form ---
    ob_start();
    ?>
    <div class="mr-scholarship-form-container">
        <?php if (!empty($feedback_message)): ?>
            <div class="mr-scholarship-message mr-<?php echo esc_attr($message_class); ?>">
                <?php echo wp_kses_post($feedback_message); ?>
            </div>
        <?php endif; ?>

        <form id="scholarshipForm" method="post" action="" enctype="multipart/form-data">
            <?php wp_nonce_field('mr_scholarship_form_action', 'mr_scholarship_nonce'); ?>
            <div class="header">
                <h2>महेन्द्ररत्न बहुमुखी क्याम्पस, इलामको</h2>
                <h3>क्याम्पस विद्यार्थी कल्याण तथा खेलकुद शाखा</h3>
            </div>
            <div class="recipient">
                श्रीमान् क्याम्पस प्रमुख ज्यू,<br>
                महेन्द्ररत्न बहुमुखी क्याम्पस, इलाम
            </div>
            <div class="subject">
                विषयः गरीब तथा जेहेन्दार वा निरशुल्क छात्रवृत्ति सम्बन्धमा ।
            </div>
            <div class="salutation">
                महोदय,
            </div>
            <p>
                म यस क्याम्पसको देहायको विवरणमा रही अध्ययनरत छु । यस क्याम्पसद्वारा उपलब्ध गराईने छात्रवृत्तिका लागि आफूलाई
                देहायको क्षेत्र वा वर्गमा योग्य ठानी यो निवेदन पेस गरेको छु ।
            </p>


            <div class="form-section personal-details">
                <div class="input-group">
                    <label for="name_nepali">१ विद्यार्थीको नामः- देवनागरीमा *:</label>
                    <input type="text" id="name_nepali" name="name_nepali" required
                        value="<?php echo isset($_POST['name_nepali']) ? esc_attr($_POST['name_nepali']) : ''; ?>">
                </div>
                <div class="input-group">
                    <label for="name_english">Name In: BLOCK LETTERS *:</label>
                    <input type="text" id="name_english" name="name_english" required class="block-letters"
                        value="<?php echo isset($_POST['name_english']) ? esc_attr($_POST['name_english']) : ''; ?>">
                </div>
                <div class="input-group">
                    <label>२ जन्म मिति *:</label>
                    <span>
                        वि.सं. <input type="text" id="dob_year_bs" name="dob_year_bs" required size="4" placeholder="साल"
                            class="input-inline"
                            value="<?php echo isset($_POST['dob_year_bs']) ? esc_attr($_POST['dob_year_bs']) : ''; ?>">
                        <input type="text" id="dob_month_bs" name="dob_month_bs" required size="10" placeholder="महिना"
                            class="input-inline"
                            value="<?php echo isset($_POST['dob_month_bs']) ? esc_attr($_POST['dob_month_bs']) : ''; ?>">
                        <input type="text" id="dob_day_bs" name="dob_day_bs" required size="2" placeholder="गते"
                            class="input-inline"
                            value="<?php echo isset($_POST['dob_day_bs']) ? esc_attr($_POST['dob_day_bs']) : ''; ?>">
                    </span>
                </div>
                <!-- Address fields - all on one line -->
                <div class="input-group address-group">
                    <label>ठेगाना *:</label>
                    <div class="input-container">
                        <div class="address-fields">
                            <div class="address-field">
                                <label>जिल्लाः</label>
                                <input type="text" name="address_district" required
                                    value="<?php echo isset($_POST['address_district']) ? esc_attr($_POST['address_district']) : ''; ?>">
                            </div>
                            <div class="address-field">
                                <label>न.पा./गा.पा.:</label>
                                <input type="text" name="address_municipality" required
                                    value="<?php echo isset($_POST['address_municipality']) ? esc_attr($_POST['address_municipality']) : ''; ?>">
                            </div>
                            <div class="address-field">
                                <label>वडा नं.:</label>
                                <input type="text" name="address_ward" required
                                    value="<?php echo isset($_POST['address_ward']) ? esc_attr($_POST['address_ward']) : ''; ?>">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label for="father_name">४ बुबाको नाम *:</label>
                    <input type="text" id="father_name" name="father_name" required size="20" class="input-inline"
                        value="<?php echo isset($_POST['father_name']) ? esc_attr($_POST['father_name']) : ''; ?>">
                    पेशा: <input type="text" id="father_occupation" name="father_occupation" size="15" class="input-inline"
                        value="<?php echo isset($_POST['father_occupation']) ? esc_attr($_POST['father_occupation']) : ''; ?>">
                </div>
                <div class="input-group">
                    <label for="grandfather_name">५ बाजेको नाम *:</label>
                    <input type="text" id="grandfather_name" name="grandfather_name" required size="20" class="input-inline"
                        value="<?php echo isset($_POST['grandfather_name']) ? esc_attr($_POST['grandfather_name']) : ''; ?>">
                    पेशा: <input type="text" id="grandfather_occupation" name="grandfather_occupation" size="15"
                        class="input-inline"
                        value="<?php echo isset($_POST['grandfather_occupation']) ? esc_attr($_POST['grandfather_occupation']) : ''; ?>">
                </div>
                <div class="input-group">
                    <label>६ शैक्षिक भर्ना विवरण *:</label>
                    <div class="academic-details">
                        <span class="field-group">
                            <label for="faculty">संकायः</label>
                            <input type="text" id="faculty" name="faculty" required size="10" class="input-inline"
                                value="<?php echo isset($_POST['faculty']) ? esc_attr($_POST['faculty']) : ''; ?>">
                        </span>
                        <span class="field-group">
                            <label for="ac_level">तहः</label>
                            <input type="text" id="ac_level" name="ac_level" required size="10" class="input-inline"
                                value="<?php echo isset($_POST['ac_level']) ? esc_attr($_POST['ac_level']) : ''; ?>">
                        </span>
                        <span class="field-group">
                            <label for="ac_year">वर्षः</label>
                            <input type="text" id="ac_year" name="ac_year" class="input-inline" placeholder="वर्ष"
                                value="<?php echo isset($_POST['ac_year']) ? esc_attr($_POST['ac_year']) : ''; ?>">
                        </span>
                    </div>
                </div>

                <div class="input-group">
                    <label></label>
                    <span class="enrollment-fields">
                        <span class="field-pair">
                            <span class="field-label">भर्ना वर्ष *:</span>
                            <input type="text" id="admission_year" name="admission_year" required size="4"
                                class="input-inline"
                                value="<?php echo isset($_POST['admission_year']) ? esc_attr($_POST['admission_year']) : ''; ?>">
                        </span>
                        <span class="field-pair">
                            <span class="field-label">रोल नं.:</span>
                            <input type="text" id="roll_no" name="roll_no" required size="10" class="input-inline"
                                value="<?php echo isset($_POST['roll_no']) ? esc_attr($_POST['roll_no']) : ''; ?>">
                        </span>
                        <span class="field-pair">
                            <span class="field-label">फोन नं.:</span>
                            <input type="text" id="phone_no" name="phone_no" required size="15" class="input-inline"
                                value="<?php echo isset($_POST['phone_no']) ? esc_attr($_POST['phone_no']) : ''; ?>">
                        </span>
                    </span>
                </div>
                <div class="input-group">
                    <label>७ बैंकको नाम र बैंक खाता:</label>
                    <span class="bank-name-section">
                        <span>(बैंक खाता भएको भए)</span>
                        <?php $selected_bank = isset($_POST['bank_name']) ? $_POST['bank_name'] : ''; ?>
                        <span class="bank-radio-option">क. माछापुच्छ्रे बैंक <input type="radio" name="bank_name"
                                value="Machhapuchchhre Bank" <?php checked($selected_bank, 'Machhapuchchhre Bank'); ?>></span>
                        <span class="bank-radio-option">ख. प्रभु बैंक <input type="radio" name="bank_name"
                                value="Prabhu Bank" <?php checked($selected_bank, 'Prabhu Bank'); ?>></span>
                        <span class="bank-radio-option">ग. नेपाल बैंक <input type="radio" name="bank_name"
                                value="Nepal Bank" <?php checked($selected_bank, 'Nepal Bank'); ?>></span>
                    </span>
                </div>

                <!-- Replace the account info section with this code -->
                <div class="bank-account-container">
                    <div class="bank-account-field">
                        <label for="account_no">घ) खाता नं.:</label>
                        <input type="text" id="account_no" name="account_no"
                            value="<?php echo isset($_POST['account_no']) ? esc_attr($_POST['account_no']) : ''; ?>">
                    </div>
                    <div class="bank-account-field">
                        <label for="bank_branch">ङ) शाखा कार्यालय:</label>
                        <input type="text" id="bank_branch" name="bank_branch"
                            value="<?php echo isset($_POST['bank_branch']) ? esc_attr($_POST['bank_branch']) : ''; ?>">
                    </div>
                </div>
            </div>

            <div class="form-section academic-history">
                <strong>७. शैक्षिक विवरण</strong>
                <table>
                    <thead>
                        <tr>
                            <th>तह</th>
                            <th>अध्ययन गरेको संस्थाको नाम र ठेगाना</th>
                            <th>GPA %</th>
                            <th>कैफियत</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>+२</td>
                            <td><input type="text" name="academic_plus2_institution"
                                    value="<?php echo isset($_POST['academic_plus2_institution']) ? esc_attr($_POST['academic_plus2_institution']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_plus2_gpa" size="5"
                                    value="<?php echo isset($_POST['academic_plus2_gpa']) ? esc_attr($_POST['academic_plus2_gpa']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_plus2_remarks"
                                    value="<?php echo isset($_POST['academic_plus2_remarks']) ? esc_attr($_POST['academic_plus2_remarks']) : ''; ?>">
                            </td>
                        </tr>
                        <tr>
                            <td>स्नातक प्रथम वर्ष</td>
                            <td><input type="text" name="academic_bachelor1_institution"
                                    value="<?php echo isset($_POST['academic_bachelor1_institution']) ? esc_attr($_POST['academic_bachelor1_institution']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor1_gpa" size="5"
                                    value="<?php echo isset($_POST['academic_bachelor1_gpa']) ? esc_attr($_POST['academic_bachelor1_gpa']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor1_remarks"
                                    value="<?php echo isset($_POST['academic_bachelor1_remarks']) ? esc_attr($_POST['academic_bachelor1_remarks']) : ''; ?>">
                            </td>
                        </tr>
                        <tr>
                            <td>स्नातक द्वितिय वर्ष</td>
                            <td><input type="text" name="academic_bachelor2_institution"
                                    value="<?php echo isset($_POST['academic_bachelor2_institution']) ? esc_attr($_POST['academic_bachelor2_institution']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor2_gpa" size="5"
                                    value="<?php echo isset($_POST['academic_bachelor2_gpa']) ? esc_attr($_POST['academic_bachelor2_gpa']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor2_remarks"
                                    value="<?php echo isset($_POST['academic_bachelor2_remarks']) ? esc_attr($_POST['academic_bachelor2_remarks']) : ''; ?>">
                            </td>
                        </tr>
                        <tr>
                            <td>स्नातक तृतीय वर्ष</td>
                            <td><input type="text" name="academic_bachelor3_institution"
                                    value="<?php echo isset($_POST['academic_bachelor3_institution']) ? esc_attr($_POST['academic_bachelor3_institution']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor3_gpa" size="5"
                                    value="<?php echo isset($_POST['academic_bachelor3_gpa']) ? esc_attr($_POST['academic_bachelor3_gpa']) : ''; ?>">
                            </td>
                            <td><input type="text" name="academic_bachelor3_remarks"
                                    value="<?php echo isset($_POST['academic_bachelor3_remarks']) ? esc_attr($_POST['academic_bachelor3_remarks']) : ''; ?>">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-section attachments">
                <strong>८. संलग्न कागजात</strong>
                <ol style="list-style-type: none; padding-left: 20px;">
                    <li>
                        क. सम्बन्धित तहको अघिल्लो वर्षका लब्धाङ्क पत्रको प्रमाणित प्रतिलिपि<br>
                        <div class="file-upload">
                            <label for="document_1" class="file-label">File attachment *:</label>
                            <input type="file" id="document_1" name="document_1" required accept=".pdf,.jpg,.jpeg,.png"
                                class="file-input">
                        </div>
                    </li>
                    <li>
                        ख. गरीब विद्यार्थीका हकमा सम्बन्धित निकायको सिफारिस पत्र<br>
                        <div class="file-upload">
                            <label for="document_2" class="file-label">File attachment:</label>
                            <input type="file" id="document_2" name="document_2" accept=".pdf,.jpg,.jpeg,.png"
                                class="file-input">
                        </div>
                    </li>

                    <li>
                        ग. आन्तरिक परीक्षामा अब्बल भएको सम्बन्धित विभागको सिफारिस पत्र<br>
                        <div class="file-upload">
                            <label for="document_3" class="file-label">File attachment:</label>
                            <input type="file" id="document_3" name="document_3" accept=".pdf,.jpg,.jpeg,.png"
                                class="file-input">
                        </div>
                    </li>
                </ol>
                <p><em><?php esc_html_e('Note: Upload documents in PDF, JPG, or PNG format only. Maximum file size: 2MB per file.', 'mr-scholarship'); ?></em>
                </p>
            </div>

            <div class="declaration">
                <p>
                    माथि उल्लेख गरिएको व्यहोरा ठीक साँचो हो, झुट्टा भए कानून बमोजिम सहुँला बुझाउँला ।
                </p>
                <div class="signature-section">
                    <label>मिति:</label>
                    इति सम्वत् <input type="text" id="submit_year_bs" name="submit_year_bs" size="4" placeholder="साल"
                        class="input-inline"
                        value="<?php echo isset($_POST['submit_year_bs']) ? esc_attr($_POST['submit_year_bs']) : ''; ?>">
                    <input type="text" id="submit_month_bs" name="submit_month_bs" size="10" placeholder="महिना"
                        class="input-inline"
                        value="<?php echo isset($_POST['submit_month_bs']) ? esc_attr($_POST['submit_month_bs']) : ''; ?>">
                    <input type="text" id="submit_day_bs" name="submit_day_bs" size="2" placeholder="गते"
                        class="input-inline"
                        value="<?php echo isset($_POST['submit_day_bs']) ? esc_attr($_POST['submit_day_bs']) : ''; ?>">
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <input type="submit" name="mr_scholarship_submit"
                    value="<?php esc_attr_e('Submit Application', 'mr-scholarship'); ?>" class="submit-button">
            </div>

        </form>
    </div>
    <?php
    return ob_get_clean(); // Return buffered content
}
add_action('admin_menu', 'mr_scholarship_admin_menu');
function mr_scholarship_admin_menu()
{
    add_menu_page(
        __('Scholarship Submissions', 'mr-scholarship'), // Page Title
        __('Scholarship', 'mr-scholarship'),             // Menu Title
        'read',                                          // Changed from 'edit_pages' to 'read' - all logged-in users have this
        'scholarship-submissions',                       // Menu Slug
        'mr_scholarship_admin_page_content',             // Function to display page content
        'dashicons-welcome-learn-more',                  // Icon URL/Dashicon class
        26                                               // Position
    );
}

// --- Admin Page Content & List Table ---
function mr_scholarship_admin_page_content()
{
    if (!current_user_can('read')) {
        wp_die(__('You do not have sufficient permissions to access this page.', 'mr-scholarship'));
    }

    // HANDLE ACTIONS FIRST - BEFORE ANY OUTPUT
    
    // Check for View Document Action FIRST
    if (isset($_GET['action']) && $_GET['action'] === 'view_document' && isset($_GET['submission_id']) && isset($_GET['doc_number'])) {
        mr_scholarship_redirect_to_document(intval($_GET['submission_id']), intval($_GET['doc_number']));
        // This function should exit, so no further processing
        return;
    }

    // Check for View HTML Action
    if (isset($_GET['action']) && $_GET['action'] === 'view_html' && isset($_GET['submission_id'])) {
        mr_scholarship_display_html_view(intval($_GET['submission_id']));
        // This function should exit, so no further processing
        return;
    }
    
    global $wpdb;
    $table_name = MR_SCHOLARSHIP_TABLE_NAME;
    $message = '';
    $message_type = '';

    // Process delete action
    if (isset($_GET['action']) && $_GET['action'] === 'delete' && isset($_GET['submission_id']) && isset($_GET['_wpnonce'])) {
        $submission_id = intval($_GET['submission_id']);

        if (wp_verify_nonce($_GET['_wpnonce'], 'delete_submission_' . $submission_id)) {
            // First get the submission data to find document paths
            $submission = $wpdb->get_row($wpdb->prepare(
                "SELECT document_1, document_2, document_3 FROM $table_name WHERE id = %d",
                $submission_id
            ));

            if ($submission) {
                // Delete the physical files if they exist
                if (!empty($submission->document_1)) {
                    $file_path = wp_upload_dir()['basedir'] . '/' . $submission->document_1;
                    if (file_exists($file_path)) {
                        wp_delete_file($file_path);
                    }
                }

                if (!empty($submission->document_2)) {
                    $file_path = wp_upload_dir()['basedir'] . '/' . $submission->document_2;
                    if (file_exists($file_path)) {
                        wp_delete_file($file_path);
                    }
                }

                if (!empty($submission->document_3)) {
                    $file_path = wp_upload_dir()['basedir'] . '/' . $submission->document_3;
                    if (file_exists($file_path)) {
                        wp_delete_file($file_path);
                    }
                }

                // Then delete the database record
                $result = $wpdb->delete(
                    $table_name,
                    array('id' => $submission_id),
                    array('%d')
                );

                if ($result !== false) {
                    $message = __('Submission and associated documents deleted successfully.', 'mr-scholarship');
                    $message_type = 'success';
                } else {
                    $message = __('Error deleting submission from database.', 'mr-scholarship');
                    $message_type = 'error';
                }
            } else {
                $message = __('Submission not found.', 'mr-scholarship');
                $message_type = 'error';
            }
        } else {
            $message = __('Security check failed.', 'mr-scholarship');
            $message_type = 'error';
        }
    }

    // Add custom CSS for column widths
    ?>
    <style>
        /* Custom column widths */
        .column-id {
            width: 50px;
        }

        .column-name {
            width: 180px;
        }

        .column-roll {
            width: 80px;
        }

        .column-phone {
            width: 100px;
        }

        .column-faculty {
            width: 120px;
        }

        .column-level {
            width: 80px;
        }

        .column-year {
            width: 60px;
        }

        .column-date {
            width: 120px;
        }

        .column-actions {
            width: 220px;
        }

        /* Style for document buttons */
        .doc-button {
            margin: 2px !important;
            padding: 2px 8px !important;
            font-size: 11px !important;
        }

        /* Add a hover tooltip */
        .doc-button[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 12px;
            z-index: 100;
        }

        .doc-button-container {
            position: relative;
            display: inline-block;
        }

        /* Style for delete button */
        .delete-button {
            color: #a00 !important;
            margin: 2px !important;
            padding: 2px 8px !important;
            font-size: 11px !important;
        }

        .delete-button:hover {
            color: #dc3232 !important;
        }
    </style>

    <div class="wrap">
        <h1><?php esc_html_e('Scholarship Submissions', 'mr-scholarship'); ?></h1>

        <?php
        // Display admin messages
        if (!empty($message)) {
            $notice_class = ($message_type === 'success') ? 'notice-success' : 'notice-error';
            echo '<div class="notice ' . esc_attr($notice_class) . ' is-dismissible"><p>' . esc_html($message) . '</p></div>';
        }
        ?>

        <table class="wp-list-table widefat fixed striped posts">
            <thead>
                <tr>
                    <th scope="col" class="manage-column column-id"><?php esc_html_e('ID', 'mr-scholarship'); ?></th>
                    <th scope="col" class="manage-column column-name"><?php esc_html_e('Person Name', 'mr-scholarship'); ?>
                    </th>
                    <th scope="col" class="manage-column column-roll"><?php esc_html_e('रोल नं', 'mr-scholarship'); ?></th>
                    <th scope="col" class="manage-column column-phone"><?php esc_html_e('फोन नं', 'mr-scholarship'); ?></th>
                    <th scope="col" class="manage-column column-faculty"><?php esc_html_e('संकाय', 'mr-scholarship'); ?>
                    </th>
                    <th scope="col" class="manage-column column-level"><?php esc_html_e('तहः', 'mr-scholarship'); ?></th>
                    <th scope="col" class="manage-column column-year"><?php esc_html_e('वर्षः', 'mr-scholarship'); ?></th>
                    <th scope="col" class="manage-column column-date"><?php esc_html_e('Submitted', 'mr-scholarship'); ?>
                    </th>
                    <th scope="col" class="manage-column column-actions"><?php esc_html_e('Actions', 'mr-scholarship'); ?>
                    </th>
                </tr>
            </thead>
            <tbody id="the-list">
                <?php
                // Fetch all necessary columns including document URLs
                $submissions = $wpdb->get_results($wpdb->prepare(
                    "SELECT id, name_english, roll_no, phone_no, faculty, ac_level, ac_year, submission_time, document_1, document_2, document_3 FROM $table_name ORDER BY submission_time DESC LIMIT %d",
                    100 // Limit results for performance
                ));

                if ($submissions) {
                    foreach ($submissions as $submission) {
                        // Use regular admin.php URL for HTML view
                        $view_html_url = add_query_arg(array(
                            'page' => 'scholarship-submissions',
                            'action' => 'view_html',
                            'submission_id' => $submission->id,
                        ), admin_url('admin.php'));

                        // Generate document URLs
                        $doc1_url = add_query_arg(array(
                            'page' => 'scholarship-submissions',
                            'action' => 'view_document',
                            'submission_id' => $submission->id,
                            'doc_number' => 1,
                        ), admin_url('admin.php'));

                        $doc2_url = add_query_arg(array(
                            'page' => 'scholarship-submissions',
                            'action' => 'view_document',
                            'submission_id' => $submission->id,
                            'doc_number' => 2,
                        ), admin_url('admin.php'));

                        $doc3_url = add_query_arg(array(
                            'page' => 'scholarship-submissions',
                            'action' => 'view_document',
                            'submission_id' => $submission->id,
                            'doc_number' => 3,
                        ), admin_url('admin.php'));

                        // Generate delete URL with nonce
                        $delete_url = wp_nonce_url(
                            add_query_arg(array(
                                'page' => 'scholarship-submissions',
                                'action' => 'delete',
                                'submission_id' => $submission->id,
                            ), admin_url('admin.php')),
                            'delete_submission_' . $submission->id
                        );

                        echo '<tr>';
                        echo '<td class="column-id">' . esc_html($submission->id) . '</td>';
                        echo '<td class="column-name"><strong>' . esc_html($submission->name_english ?: 'N/A') . '</strong></td>';
                        echo '<td class="column-roll">' . esc_html($submission->roll_no ?: '-') . '</td>';
                        echo '<td class="column-phone">' . esc_html($submission->phone_no ?: '-') . '</td>';
                        echo '<td class="column-faculty">' . esc_html($submission->faculty ?: '-') . '</td>';
                        echo '<td class="column-level">' . esc_html($submission->ac_level ?: '-') . '</td>';
                        echo '<td class="column-year">' . esc_html($submission->ac_year ?: '-') . '</td>';
                        echo '<td class="column-date">' . date_i18n(get_option('date_format'), strtotime($submission->submission_time)) . '</td>';
                        echo '<td class="column-actions">';

                        // HTML View button
                        echo '<a href="' . esc_url($view_html_url) . '" class="button button-small doc-button" data-tooltip="View application" target="_blank">' . esc_html__('HTML', 'mr-scholarship') . '</a> ';

                        // Document buttons - only show if document exists
                        if (!empty($submission->document_1)) {
                            echo '<a href="' . esc_url($doc1_url) . '" class="button button-small doc-button" data-tooltip="सिफारिस पत्र" target="_blank">Doc1</a> ';
                        } else {
                            echo '<span class="button button-small doc-button disabled" style="opacity:0.5;">Doc1</span> ';
                        }

                        if (!empty($submission->document_2)) {
                            echo '<a href="' . esc_url($doc2_url) . '" class="button button-small doc-button" data-tooltip="लब्धाङ्क पत्र" target="_blank">Doc2</a> ';
                        } else {
                            echo '<span class="button button-small doc-button disabled" style="opacity:0.5;">Doc2</span> ';
                        }

                        if (!empty($submission->document_3)) {
                            echo '<a href="' . esc_url($doc3_url) . '" class="button button-small doc-button" data-tooltip="सिफारिस पत्र" target="_blank">Doc3</a> ';
                        } else {
                            echo '<span class="button button-small doc-button disabled" style="opacity:0.5;">Doc3</span> ';
                        }

                        // Add delete button with confirmation
                        echo '<a href="' . esc_url($delete_url) . '" class="button button-small delete-button" data-tooltip="Delete submission" onclick="return confirm(\'' . esc_js(__('Are you sure you want to delete this submission?', 'mr-scholarship')) . '\');">' . esc_html__('Delete', 'mr-scholarship') . '</a>';

                        echo '</td>';
                        echo '</tr>';
                    }
                } else {
                    echo '<tr><td colspan="9">' . esc_html__('No submissions found.', 'mr-scholarship') . '</td></tr>';
                }
                ?>
            </tbody>
            <tfoot>
                <tr>
                    <th scope="col" class="column-id"><?php esc_html_e('ID', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-name"><?php esc_html_e('नाम', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-roll"><?php esc_html_e('रोल नं', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-phone"><?php esc_html_e('फोन नं', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-faculty"><?php esc_html_e('संकाय', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-level"><?php esc_html_e('तहः', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-year"><?php esc_html_e('वर्षः', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-date"><?php esc_html_e('Submitted', 'mr-scholarship'); ?></th>
                    <th scope="col" class="column-actions"><?php esc_html_e('Actions', 'mr-scholarship'); ?></th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?php
}

/**
 * Redirect to the document URL based on submission ID and document number
 */
/**
 * Redirect to the document URL based on submission ID and document number
 */
function mr_scholarship_redirect_to_document($submission_id, $doc_number)
{
    global $wpdb;
    $table_name = MR_SCHOLARSHIP_TABLE_NAME;

    // Validate document number
    if (!in_array($doc_number, [1, 2, 3])) {
        wp_die(esc_html__('Invalid document number.', 'mr-scholarship'));
    }

    // Get the submission data with all document columns
    $submission = $wpdb->get_row($wpdb->prepare(
        "SELECT document_1, document_2, document_3 FROM $table_name WHERE id = %d",
        $submission_id
    ));

    if (!$submission) {
        wp_die(esc_html__('Submission not found.', 'mr-scholarship'));
    }

    // Get the specific document URL based on doc_number
    $document_url = '';
    switch ($doc_number) {
        case 1:
            $document_url = $submission->document_1;
            break;
        case 2:
            $document_url = $submission->document_2;
            break;
        case 3:
            $document_url = $submission->document_3;
            break;
    }

    // Check if document exists
    if (empty($document_url)) {
        wp_die(esc_html__('Document not found or not uploaded.', 'mr-scholarship'));
    }

    // Clear any output buffers and redirect
    if (ob_get_level()) {
        ob_end_clean();
    }
    
    // Use JavaScript redirect as a fallback if headers are already sent
    if (headers_sent()) {
        echo '<script type="text/javascript">';
        echo 'window.location.href="' . esc_js($document_url) . '";';
        echo '</script>';
        echo '<noscript>';
        echo '<meta http-equiv="refresh" content="0;url=' . esc_attr($document_url) . '" />';
        echo '</noscript>';
        exit;
    }
    
    // Normal redirect
    wp_redirect($document_url);
    exit;
}
/**
 * FIXED: Display HTML view function with proper output buffering
 */
function mr_scholarship_display_html_view($submission_id)
{
    global $wpdb;
    $table_name = MR_SCHOLARSHIP_TABLE_NAME;

    // Fetch the specific submission data
    $submission_data = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $submission_id), ARRAY_A);

    if (!$submission_data) {
        wp_die(esc_html__('Submission not found.', 'mr-scholarship'));
    }

    // Clear all output buffers
    while (ob_get_level()) {
        ob_end_clean();
    }

    // Start output buffering to capture any unwanted output
    ob_start();
    
    // Set headers
    header('Content-Type: text/html; charset=UTF-8');
    header('Cache-Control: no-cache, must-revalidate');
    header('Pragma: no-cache');
    
    // Clean the buffer and start fresh
    ob_end_clean();
    
    // Complete standalone HTML with no WordPress dependencies
    echo '<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>' . esc_html(sprintf(__('Scholarship Application - %s', 'mr-scholarship'), $submission_data['name_english'])) . '</title>
        <style>
            /* A4 paper dimensions and print settings */
            @page {
                size: A4 portrait;
                margin: 0;
            }
            
            @media print {
                html, body {
                    width: 210mm;
                    height: 297mm;
                    margin: 0;
                    padding: 0;
                }
                .no-print {
                    display: none !important;
                }
                body {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .printable-content {
                    box-shadow: none;
                    margin: 0;
                    padding: 15mm 15mm;
                    width: 180mm;
                    height: 267mm;
                }
            }
            
            /* Basic styling for the HTML view */
            body {
                font-family: "Arial Unicode MS", "Noto Sans", sans-serif;
                line-height: 1.4;
                color: #333;
                background: #f9f9f9;
                margin: 0;
                padding: 0;
            }
            .printable-content {
                background: #fff;
                width: 180mm;
                min-height: 267mm;
                margin: 10px auto;
                padding: 15mm 15mm;
                box-sizing: border-box;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                position: relative;
            }
            .header {
                text-align: center;
                margin-bottom: 12px;
            }
            .header h2 {
                margin: 0 0 4px 0;
                font-size: 18px;
                font-weight: bold;
            }
            .header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: bold;
            }
            .subject {
                text-align: center;
                font-weight: bold;
                margin: 15px 0;
                text-decoration: underline;
                font-size: 15px;
            }
            .recipient {
                margin-bottom: 15px;
                font-size: 14px;
                line-height: 1.5;
            }
            .data-group {
                margin-bottom: 6px;
                font-size: 13px;
                line-height: 1.5;
            }
            .data-group .label {
                font-weight: bold;
                display: inline-block;
                min-width: 170px;
                vertical-align: top;
            }
            .data-group .value {
                display: inline-block;
                max-width: calc(100% - 175px);
                vertical-align: top;
            }
            p {
                margin: 8px 0;
                font-size: 13px;
                line-height: 1.5;
            }
            .salutation {
                margin-bottom: 8px;
                font-size: 14px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 12px 0;
                font-size: 12px;
            }
            th, td {
                padding: 6px;
                text-align: left;
                border: 1px solid #ddd;
                vertical-align: top;
            }
            th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            .actions {
                text-align: center;
                margin: 20px 0;
            }
            .print-button {
                background: #4CAF50;
                color: white;
                border: none;
                padding: 10px 20px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 4px;
            }
            .back-button {
                background: #555;
                color: white;
                border: none;
                padding: 10px 20px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 4px;
            }
            /* For Nepali text */
            .nepali-text {
                font-family: "Arial Unicode MS", "Noto Sans", sans-serif;
            }
            .form-section {
                margin-bottom: 12px;
            }
            .form-section strong {
                font-size: 14px;
                display: block;
                margin-bottom: 6px;
            }
            .attachments ol {
                margin: 6px 0;
                padding-left: 20px;
            }
            .attachments li {
                font-size: 13px;
                margin-bottom: 4px;
                line-height: 1.4;
            }
            .declaration {
                margin-top: 15px;
            }
            .declaration p {
                font-size: 13px;
                margin: 8px 0;
            }
            .signature-section {
                font-size: 13px;
                margin-top: 15px;
                line-height: 1.5;
            }
            .block-letters {
                text-transform: uppercase;
            }
        </style>
    </head>
    <body>
        <div class="printable-content">
            <div class="header nepali-text">
                <h2>महेन्द्ररत्न बहुमुखी क्याम्पस, इलामको</h2>
                <h3>क्याम्पस विद्यार्थी कल्याण तथा खेलकुद शाखा</h3>
            </div>
            <div class="recipient nepali-text">
                श्रीमान् क्याम्पस प्रमुख ज्यू,<br>
                महेन्द्ररत्न बहुमुखी क्याम्पस, इलाम
            </div>
            <div class="subject nepali-text">
                विषयः गरीब तथा जेहेन्दार वा निरशुल्क छात्रवृत्ति सम्बन्धमा ।
            </div>
            <div class="salutation nepali-text">महोदय,</div>
            <p class="nepali-text">
                म यस क्याम्पसको देहायको विवरणमा रही अध्ययनरत छु । यस क्याम्पसद्वारा उपलब्ध गराईने छात्रवृत्तिका लागि आफूलाई देहायको क्षेत्र वा वर्गमा योग्य ठानी यो निवेदन पेस गरेको छु ।
            </p>

            <div class="form-section personal-details nepali-text">
                <div class="data-group"><span class="label">१ विद्यार्थीको नामः- देवनागरीमा:</span> <span class="value">' . esc_html($submission_data['name_nepali']) . '</span></div>
                <div class="data-group"><span class="label">Name In: BLOCK LETTERS:</span> <span class="value block-letters">' . esc_html($submission_data['name_english']) . '</span></div>
                <div class="data-group"><span class="label">२ जन्म मितिः</span> <span class="value">वि.सं. ' . esc_html($submission_data['dob_year_bs']) . ' साल ' . esc_html($submission_data['dob_month_bs']) . ' महिना ' . esc_html($submission_data['dob_day_bs']) . ' गते</span></div>
                <div class="data-group"><span class="label">३ ठेगानाः</span> <span class="value">जिल्ला: ' . esc_html($submission_data['address_district']) . ', न.पा./गा.पा: ' . esc_html($submission_data['address_municipality']) . ', वडा नं: ' . esc_html($submission_data['address_ward']) . '</span></div>
                <div class="data-group"><span class="label">४ बुबाको नामः</span> <span class="value">' . esc_html($submission_data['father_name']) . ' (पेशा: ' . esc_html($submission_data['father_occupation']) . ')</span></div>
                <div class="data-group"><span class="label">५ बाजेको नामः</span> <span class="value">' . esc_html($submission_data['grandfather_name']) . ' (पेशा: ' . esc_html($submission_data['grandfather_occupation']) . ')</span></div>
                <div class="data-group"><span class="label">६ शैक्षिक भर्ना विवरणः</span> <span class="value">संकायः ' . esc_html($submission_data['faculty']) . ', तहः ' . esc_html($submission_data['ac_level']) . ', वर्षः ' . esc_html($submission_data['ac_year']) . '</span></div>
                <div class="data-group"><span class="label"></span><span class="value">भर्ना वर्षः ' . esc_html($submission_data['admission_year']) . ', रोल नं.: ' . esc_html($submission_data['roll_no']) . ', फोन नं.: ' . esc_html($submission_data['phone_no']) . '</span></div>
                <div class="data-group"><span class="label">७ बैंकको नाम र बैंक खाता:</span> <span class="value">' . esc_html($submission_data['bank_name'] ?: 'N/A') . '</span></div>
                <div class="data-group"><span class="label">घ) खाता नं.:</span> <span class="value">' . esc_html($submission_data['account_no'] ?: 'N/A') . '</span></div>
                <div class="data-group"><span class="label">ङ) शाखा कार्यालय:</span> <span class="value">' . esc_html($submission_data['bank_branch'] ?: 'N/A') . '</span></div>
            </div>

            <div class="form-section academic-history nepali-text">
                <strong>८. शैक्षिक विवरण</strong>
                <table>
                    <thead>
                        <tr>
                            <th width="15%">तह</th>
                            <th width="50%">अध्ययन गरेको संस्थाको नाम र ठेगाना</th>
                            <th width="15%">GPA %</th>
                            <th width="20%">कैफियत</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>+२</td>
                            <td>' . esc_html($submission_data['academic_plus2_institution']) . '</td>
                            <td>' . esc_html($submission_data['academic_plus2_gpa']) . '</td>
                            <td>' . esc_html($submission_data['academic_plus2_remarks']) . '</td>
                        </tr>
                        <tr>
                            <td>स्नातक प्रथम वर्ष</td>
                            <td>' . esc_html($submission_data['academic_bachelor1_institution']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor1_gpa']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor1_remarks']) . '</td>
                        </tr>
                        <tr>
                            <td>स्नातक द्वितिय वर्ष</td>
                            <td>' . esc_html($submission_data['academic_bachelor2_institution']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor2_gpa']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor2_remarks']) . '</td>
                        </tr>
                        <tr>
                            <td>स्नातक तृतीय वर्ष</td>
                            <td>' . esc_html($submission_data['academic_bachelor3_institution']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor3_gpa']) . '</td>
                            <td>' . esc_html($submission_data['academic_bachelor3_remarks']) . '</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-section attachments nepali-text">
                <strong>९. संलग्न कागजात (As Declared)</strong>
                <ol style="margin-top: 5px; margin-bottom: 5px; padding-left: 25px;">
                    <li>गरीब विद्यार्थीका हकमा सम्बन्धित निकायको सिफारिस पत्र</li>
                    <li>सम्बन्धित तहको अघिल्लो वर्षका लब्धाङ्क पत्रको प्रमाणित प्रतिलिपि</li>
                    <li>आन्तरिक परीक्षामा अब्बल भएको सम्बन्धित विभागको सिफारिस पत्र</li>
                </ol>
            </div>

            <div class="declaration nepali-text">
                <p>
                    माथि उल्लेख गरिएको व्यहोरा ठीक साँचो हो, झुट्टा भए कानून बमोजिम सहुँला बुझाउँला । (Submitted Online)
                </p>
                <div class="signature-section">
                    <div style="margin-bottom: 5px;">
                        <span class="label" style="font-weight: bold; display: inline-block; width: 60px;">मिति:</span>
                        <span class="value">इति सम्वत् ' . esc_html($submission_data['submit_year_bs']) . ' साल ' . esc_html($submission_data['submit_month_bs']) . ' महिना ' . esc_html($submission_data['submit_day_bs']) . ' गते</span>
                    </div>
                    <div>
                        <span class="label" style="font-weight: bold; display: inline-block; width: 60px;">Time:</span>
                        <span class="value">' . date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($submission_data['submission_time'])) . '</span>
                    </div>
                </div>
            </div>

            <div class="actions no-print" style="position: fixed; bottom: 20px; left: 0; right: 0; text-align: center;">
                <button onclick="window.print();" class="print-button">Print / Save as PDF</button>
                <a href="' . esc_url(admin_url('admin.php?page=scholarship-submissions')) . '" class="back-button">Back to List</a>
            </div>
        </div>
        <script>
            // Auto-print functionality
            window.onload = function() {
                // Give a brief delay to make sure everything loads properly
                setTimeout(function() {
                    // Uncomment this line if you want automatic printing
                    // window.print();
                }, 500);
            };
        </script>
    </body>
    </html>';

    // Make sure we exit completely - no more WordPress processing
    exit;
}